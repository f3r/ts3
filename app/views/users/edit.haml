= render :partial => 'users/user_left_column'
.edit_profile_page
  %section.span8
    .section-header #{t(:section_header_user_information)}
    = coded_errors_for @user
  
    = form_for :user, :url => user_path(@user['id']), :method => :put do |f|
      .input
        = f.label :first_name, t(:first_name)
        .public
        = f.text_field :first_name
      .input
        = f.label :last_name, t(:last_name)
        .private
        = f.text_field :last_name
      /TODO: Email has a special validation process, please check with Fer
      .input
        = f.label :email, t(:email)
        .private
        = f.text_field :email
      .input
        = f.label :gender, t(:gender)
        .private
        = f.select :gender, [['undisclosed', 'unknown'],['Male', 'male'], ['Female', 'female']]
      .input
        = f.label :phone_mobile, t(:mobile_phone)
        .private
        = f.text_field :phone_mobile
      .input
        = f.label :birthdate, t(:birthdate)
        .private
        = select_date (!@user['birthdate'].blank? ? @user['birthdate'].to_date : nil), :prefix => "birthdate", :order => [:day, :month, :year], :start_year => 1930, :end_year => Date.today.year - 18, :include_blank => true
      .clearfix
      .span3.float-right
        = submit_tag 'Save', :class => 'btn primary'
        = link_to (button_tag 'Cancel', :class => 'btn secondary'), profile_path
      .clearfix

      /Billing Address Section
      .section-header #{t(:section_header_billing_address)}
      .text
    = form_for :address, :url => user_change_address_path((@user['id'] ? @user['id'] : params[:id])), :method => :put do |f|
      -# FIXME: coded_errors_for is not working
      -# = coded_errors_for @address
      .input
        = f.label :street, t(:street)
        .private
        = f.text_field :street
      .input
        = f.label :city, t(:city)
        .public
        = f.text_field :city
      .input
        = f.label :country, t(:country)
        .public
        = f.country_select(:country, ["Singapore", "Hong Kong", "Kuala Lumpur"], :include_blank => true)
      .input
        = f.label :zip, t(:zip)
        .private
        = f.text_field :zip
        = f.hidden_field :id
      .clearfix
      .span3.float-right
        = submit_tag 'Save', :class => 'btn primary'
        = link_to (button_tag 'Cancel', :class => 'btn secondary'), profile_path
      .clearfix

    = form_for :user, :url => user_path(@user['id']), :method => :put do |f|

      /Password Section
      .section-header #{t(:section_header_user_password)}
      .input
        = label_tag 'Current Password'
        .private
        = text_field_tag 'current_password', '', :placeholder => 'current password'
      .input
        = label_tag 'Password'
        .private
        = text_field_tag 'password', ''
      .input
        = label_tag 'Re-type Password'
        .private
        = text_field_tag 'password_confirmation', ''
      .clearfix
      .span3.float-right
        = submit_tag 'Save', :class => 'btn primary'
        = link_to (button_tag 'Cancel', :class => 'btn secondary'), profile_path
      .clearfix

      -#Accounts Section
      .section-header Linked Accounts
      = render :partial => "users/user_accounts"
      .clearfix

    #avatar-modal.modal.hide.fade
      = form_for :user, :url => user_path(@user['id']), :method => :put do |f|
        .modal-header
          = link_to "x", '#', :class => "close"
          %h3 Edit your Photo
        .modal-body
          .row
            .span2
              %p
                = image_tag(@avatar, :class => "avatar_placeholder", :width => 100)
                .preview
                  Preview
            .span7
              %p= "Uploading a current photo helps renters evaluate your profile. While its not required, it helps build trust with property owners if you complete your profile."
              %p
                %a.btn.medium.facebook_avatar= "Use Facebook Photo"
                - @user_auth['authentications'].each{|x| @facebook_uid = x['uid'] if x['provider'] == "facebook" }
                = f.hidden_field(:facebook_image, :value => "http://graph.facebook.com/#{@facebook_uid}/picture?type=large") if !@facebook_uid.blank?
                = f.hidden_field :avatar_url
              %p
                %a.btn.medium.upload_avatar= "Upload a new Photo"
                .upload_field
                  = f.file_field :avatar, :onchange => "readURL(this);", :style=>"display:none;"
        .modal-footer
          = button_tag 'Save', :class => 'btn primary',  "data-loading-text" => "Saving photo...", :id => "save-btn"

<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

:javascript
  $(document).ready(function() {
    $('div.private').twipsy({html:true,placement:"above", title: function(){return "Private. Only visible to those that have an active transaction with you"} });
    $('div.public').twipsy({html:true,placement:"above", title: function(){return "Public. Anyone can see this information"} });
  });

  $(document).ready(function() {
    $('a.facebook_avatar').click(function() {
      facebook_image = $('input#user_facebook_image').val();
      $('input#user_avatar_url').val(facebook_image);
      $('.avatar_placeholder').attr('src', facebook_image).width(100);
      $('input#user_avatar').hide();
    });
    $('a.upload_avatar').click(function() {
      $('input#user_avatar').show();
      $('input#user_avatar_url').val("");
    });

    var btn = $('#save-btn').click(function () {
      btn.button('loading');
    })

  });

  function readURL(input) {
         if (input.files && input.files[0]) {
             var reader = new FileReader();
             reader.onload = function (e) {
                 $('.avatar_placeholder')
                     .attr('src', e.target.result)
                     .width(100)
             };
             reader.readAsDataURL(input.files[0]);
         }
  }
:css
  article, aside, figure, footer, header, hgroup, 
  menu, nav, section { display: block; }